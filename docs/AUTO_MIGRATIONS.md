# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

## ‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–π
**–§–∞–π–ª:** `package.json`
```json
"migration:run": "ts-node src/database/runMigrations.ts"
```

### 2. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π
**–§–∞–π–ª:** `src/database/runMigrations.ts`
- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –ó–∞–ø—É—Å–∫–∞–µ—Ç –≤—Å–µ pending –º–∏–≥—Ä–∞—Ü–∏–∏
- –õ–æ–≥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç exit code (0 = —É—Å–ø–µ—Ö, 1 = –æ—à–∏–±–∫–∞)

### 3. –û–±–Ω–æ–≤–ª—ë–Ω Dockerfile
**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- `ts-node` –∏ `typescript` –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ dependencies (–±—ã–ª–∏ –≤ devDependencies)
- –ö–æ–ø–∏—Ä—É—é—Ç—Å—è –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –º–∏–≥—Ä–∞—Ü–∏–π: `src/database/`
- –ö–æ–ø–∏—Ä—É–µ—Ç—Å—è `tsconfig.json` –¥–ª—è —Ä–∞–±–æ—Ç—ã ts-node
- `npm ci` –≤–º–µ—Å—Ç–æ `npm ci --only=production` (–Ω—É–∂–Ω—ã –≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)

### 4. –û–±–Ω–æ–≤–ª—ë–Ω CI/CD workflow
**–§–∞–π–ª:** `.github/workflows/deploy.yml`

–î–æ–±–∞–≤–ª–µ–Ω —à–∞–≥ –ø–æ—Å–ª–µ `docker compose up -d`:
```yaml
# –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
sleep 5

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞
echo "üîÑ Running database migrations..."
docker compose -f docker-compose.prod.yml exec -T bot npm run migration:run || {
  echo "‚ùå Migrations failed, but continuing with deployment"
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –ü–û–°–õ–ï —Å—Ç–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `exec -T` (non-interactive mode –¥–ª—è CI)
- –ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–ø–∞–¥—É—Ç, –¥–µ–ø–ª–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è (fail-safe)
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ)

## üîÑ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏ –∫–∞–∂–¥–æ–º –¥–µ–ø–ª–æ–µ (push –≤ main):

1. **Build** ‚Üí –°–æ–±–∏—Ä–∞–µ—Ç—Å—è Docker –æ–±—Ä–∞–∑
2. **Push** ‚Üí –û–±—Ä–∞–∑ –ø—É—à–∏—Ç—Å—è –≤ GHCR
3. **Deploy** ‚Üí –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ:
   - `docker compose down` - –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
   - `docker compose pull` - –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑
   - `docker compose up -d` - –∑–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
   - **`sleep 5`** - –∂–¥—ë–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
   - **`npm run migration:run`** - üÜï **–∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏**
   - `docker image prune` - —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã
4. **Verify** ‚Üí –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω

## üìä –ú–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è training feature

–ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –¥–µ–ø–ª–æ–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è:

1. **1707649200000-AddGameType.ts**
   - –°–æ–∑–¥–∞—Å—Ç enum `game_type` –≤ PostgreSQL
   - –î–æ–±–∞–≤–∏—Ç –∫–æ–ª–æ–Ω–∫—É `type` –≤ —Ç–∞–±–ª–∏—Ü—É `games`
   - Default –∑–Ω–∞—á–µ–Ω–∏–µ: `'GAME'`

2. **1707649300000-SetExistingGamesToGame.ts**
   - –û–±–Ω–æ–≤–∏—Ç –≤—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–ø–∏—Å–∏: `type = 'GAME'`
   - Safety check: —Ç–æ–ª—å–∫–æ –≥–¥–µ `type IS NULL`

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–π –≤ –ª–æ–≥–∞—Ö

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –≤–∏–¥–Ω–æ:

```bash
üîÑ Running database migrations...
üîÑ Initializing database connection...
‚úÖ Database connection established
üîÑ Running pending migrations...
‚úÖ Successfully ran 2 migration(s):
   - AddGameType1707649200000
   - SetExistingGamesToGame1707649300000
‚úÖ Migration process completed successfully
```

–ò–ª–∏ –µ—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:
```bash
üîÑ Running database migrations...
‚úÖ No pending migrations
```

## üö® –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –æ—à–∏–±–∫–µ –º–∏–≥—Ä–∞—Ü–∏–π

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏–∏ —É–ø–∞–¥—É—Ç:
1. –î–µ–ø–ª–æ–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è (–±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –Ω–∞ —Å—Ç–∞—Ä–æ–π —Å—Ö–µ–º–µ)
2. –í –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏
3. –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é:

```bash
# SSH –Ω–∞ —Å–µ—Ä–≤–µ—Ä
ssh user@server

# –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /opt/game-organization-bot

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—Ä—É—á–Ω—É—é
docker compose -f docker-compose.prod.yml exec bot npm run migration:run

# –ò–ª–∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker compose -f docker-compose.prod.yml logs bot
```

## üí° –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π

‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (rollback –ø—Ä–∏ –æ—à–∏–±–∫–µ)
- –ù–µ –ª–æ–º–∞—é—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏–π –±–æ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
- TypeORM –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏

‚úÖ **–£–¥–æ–±—Å—Ç–≤–æ:**
- –ù–µ –Ω—É–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –∫–æ–¥–æ–º (–¥–µ–ø–ª–æ–π –∫–æ–¥–∞ = –¥–µ–ø–ª–æ–π —Å—Ö–µ–º—ã)
- –õ–æ–≥–∏ –≤ CI/CD

‚úÖ **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å:**
- –ú–∏–≥—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã (–º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ (IF NOT EXISTS)
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏—Å—Ç–æ—Ä–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ `migrations`

## üîç –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### –õ–æ–∫–∞–ª—å–Ω–æ:
```bash
npm run migration:run
```

### –í Docker (production):
```bash
docker compose -f docker-compose.prod.yml exec bot npm run migration:run
```

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏:
```sql
SELECT * FROM migrations ORDER BY timestamp DESC;
```

## üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π –≤ –±—É–¥—É—â–µ–º

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –º–∏–≥—Ä–∞—Ü–∏–∏: `src/database/migrations/[timestamp]-[Name].ts`
2. –î–æ–±–∞–≤–∏—Ç—å –≤ `src/database/runMigrations.ts`:
   ```typescript
   import { YourMigration1234567890000 } from './migrations/1234567890000-YourMigration';
   
   migrations: [
     // ... existing
     YourMigration1234567890000,
   ],
   ```
3. Commit & push ‚Üí –º–∏–≥—Ä–∞—Ü–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –¥–µ–ø–ª–æ–µ

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –∫ –¥–µ–ø–ª–æ—é
